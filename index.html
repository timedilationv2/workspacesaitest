<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sophie AI - Integrated Workspace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

    <style>
        :root {
            --bg-main: #FDFEFE;
            --bg-secondary: #FFFFFF;
            --bg-sidebar: #F5F7FA;
            --primary-blue: #AEC6F4;
            --primary-pink: #F8C8DC;
            --text-primary: #1F2937;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
            --shadow-color: rgba(99, 102, 241, 0.1);
        }

        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
        }
        .workspace-layout {
            display: grid;
            grid-template-columns: 80px 1fr 380px;
            height: 100vh;
        }
        .sidebar-nav {
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.5rem 0;
            gap: 1rem;
        }
        .nav-item {
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            width: 70px;
            transition: background-color 0.2s ease-in-out;
        }
        .nav-item .icon { font-size: 1.75rem; line-height: 1; }
        .nav-item .label { font-size: 0.75rem; color: var(--text-secondary); }
        .nav-item:hover, .nav-item.active { background-color: var(--bg-main); }
        .nav-item.active .label { color: var(--text-primary); font-weight: 500; }
        .main-content { padding: 2rem; overflow-y: auto; }
        .widgets-column {
            background-color: var(--bg-sidebar);
            border-left: 1px solid var(--border-color);
            padding: 2rem 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .panel {
            background-color: var(--bg-secondary);
            border-radius: 1rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 12px var(--shadow-color);
            overflow: hidden;
        }
        .panel-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border-color); }
        .panel-title { font-size: 1rem; font-weight: 600; color: var(--text-primary); }
        .panel-body { padding: 1.25rem; }
        textarea, input[type=text], input[type=url] {
            background-color: #F9FAFB;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            width: 100%;
            border-radius: 0.5rem;
            padding: 0.65rem 1rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        textarea:focus, input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(174, 198, 244, 0.4);
        }
        .btn {
            padding: 0.6rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-primary { background-color: var(--text-primary); color: var(--bg-secondary); }
        .btn-primary:hover { background-color: #374151; }
        .btn-secondary { background-color: #E5E7EB; color: #374151; }
        .btn-secondary:hover { background-color: #D1D5DB; }
        #editor-input { height: 300px; font-size: 1rem; line-height: 1.6; }
        .quick-action-card {
            background-color: #F9FAFB;
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background .2s, transform .2s;
        }
        .quick-action-card:hover { background-color: #F3F4F6; transform: translateY(-2px); }
        .list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        .list-item:last-child { border-bottom: none; }
        .delete-btn {
            background: none; border: none; cursor: pointer; color: var(--text-secondary);
            opacity: 0.5; transition: opacity .2s;
        }
        .list-item:hover .delete-btn { opacity: 1; }
        .toast {
            position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%);
            background-color: var(--text-primary);
            color: var(--bg-secondary);
            padding: .75rem 1.5rem; border-radius: 9999px; font-weight: 500;
            opacity: 0; visibility: hidden; transition: all .4s ease-in-out; z-index: 100;
            box-shadow: 0 5px 15px rgba(0,0,0,.1);
        }
        .toast.show { opacity: 1; visibility: visible; bottom: 1.5rem; }
        .loader {
            width: 20px; height: 20px; border: 3px solid #FFF; border-bottom-color: transparent;
            border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="workspace-layout">
        <!-- Left Sidebar Navigation -->
        <nav class="sidebar-nav">
            <div class="nav-item active">
                <span class="icon">ü§ñ</span>
                <span class="label">Sophie</span>
            </div>
             <div class="nav-item">
                <span class="icon">üìù</span>
                <span class="label">Notes</span>
            </div>
             <div class="nav-item">
                <span class="icon">‚úÖ</span>
                <span class="label">Tasks</span>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-800">chatbot - v1.sophieAi.Bot&lt;Main&gt;</h1>
                <p class="text-gray-500 mt-1">Your intelligent assistant for writing, planning, and creating.</p>
            </div>
            
            <section id="editor-panel" class="panel">
                <div class="panel-header flex justify-between items-center">
                    <h2 class="panel-title">‚úçÔ∏è Editor</h2>
                    <button id="ask-sophie-btn" class="btn btn-primary">
                        <span id="btn-text">Ask Sophie</span>
                        <span id="loader" class="hidden loader"></span>
                    </button>
                </div>
                <div class="panel-body">
                    <textarea id="editor-input" placeholder="Start writing, or choose a prompt below to begin..."></textarea>
                    <h3 class="font-semibold mt-6 mb-3 text-gray-700">Quick Actions:</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3" id="prompt-cards"></div>
                </div>
            </section>
        </main>

        <!-- Right Widgets Column -->
        <aside class="widgets-column">
            <div class="panel">
                <div class="panel-header"><h3 class="panel-title">üéØ Today's Focus</h3></div>
                <div class="panel-body">
                    <form id="add-todo-form" class="flex gap-2 mb-3">
                        <input type="text" id="todo-input" placeholder="Add a new task..." required>
                        <button type="submit" class="btn btn-secondary !px-4">Add</button>
                    </form>
                    <div id="todo-list"></div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-header"><h3 class="panel-title">üå± Habit Tracker</h3></div>
                <div class="panel-body" id="habit-tracker"></div>
            </div>
            <div class="panel">
                <div class="panel-header"><h3 class="panel-title">üìã Quick Notes</h3></div>
                <div class="panel-body">
                    <form id="add-clipboard-form" class="flex flex-col gap-3 mb-3">
                        <textarea id="clipboard-input" placeholder="Save a quick note..." required rows="3"></textarea>
                        <button type="submit" class="btn btn-secondary self-end">Save Note</button>
                    </form>
                    <div id="clipboard-list"></div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-header"><h3 class="panel-title">üîó Saved Links</h3></div>
                <div class="panel-body">
                    <form id="add-link-form" class="flex flex-col gap-2 mb-3">
                        <input type="text" id="link-title-input" placeholder="Title" required>
                        <input type="url" id="link-url-input" placeholder="https://example.com" required>
                        <button type="submit" class="btn btn-secondary self-end">Add Link</button>
                    </form>
                    <div id="links-list"></div>
                </div>
            </div>
        </aside>
    </div>

    <div id="toast-notification" class="toast"></div>

    <script>
        // =================================================================================
        // == IMPORTANT: API KEY CONFIGURATION
        // =================================================================================
        // You MUST get your own API key from Google AI Studio and paste it here.
        // The application will not work without it.
        // 1. Go to https://aistudio.google.com/
        // 2. Click "Get API key" and create one.
        // 3. Paste the key between the quotes below.
        const YOUR_API_KEY = ""; 
        // =================================================================================

        // ===== Constants and State =====
        const LS_KEY = 'sophieAiWorkspaceState_v6';
        let state = {
            links: [], clipboard: [], todos: [], habits: {}, editorContent: ""
        };
        const prompts = [
            { title: "Proofread AI", desc: "for posting comments" },
            { title: "What's new?", desc: "on Netflix/Hulu/Prime today?" },
            { title: "To-Do List", desc: "Manual reminder for the day" },
        ];
        const dailyHabits = ["Hydrate (8 glasses)", "Move for 30 mins", "Read 10 pages", "Mindful moment"];

        // ===== DOM Helpers =====
        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => [...document.querySelectorAll(sel)];
        const ts = () => new Date().toLocaleString('en-US', { dateStyle: 'short', timeStyle: 'short' });

        // ===== UI Feedback =====
        let toastTimer;
        function showToast(msg, duration = 3000) {
            const t = $('#toast-notification');
            clearTimeout(toastTimer);
            t.textContent = msg;
            t.classList.add('show');
            toastTimer = setTimeout(() => t.classList.remove('show'), duration);
        }

        // ===== State Management =====
        function save() {
            state.editorContent = $('#editor-input').value;
            localStorage.setItem(LS_KEY, JSON.stringify(state));
        }

        function load() {
            const raw = localStorage.getItem(LS_KEY);
            if (raw) {
                const loadedState = JSON.parse(raw);
                state = {...state, ...loadedState};
            }
            $('#editor-input').value = state.editorContent || '';
            const today = new Date().toISOString().slice(0, 10);
            if (!state.habits || state.habits.date !== today) {
                state.habits = { date: today, completed: [] };
            }
            renderAll();
        }

        // ===== Rendering Functions =====
        function renderLinks() {
            $('#links-list').innerHTML = state.links.map((l, i) => `
                <div class="list-item">
                    <a href="${l.url}" target="_blank" rel="noopener" class="text-blue-600 hover:underline text-sm font-medium break-all">${l.title}</a>
                    <button data-act="del" data-type="links" data-index="${i}" class="delete-btn">‚ùå</button>
                </div>
            `).join('') || `<p class="text-xs text-center text-gray-400 py-2">No links saved.</p>`;
        }
        
        function renderTodos() {
            $('#todo-list').innerHTML = state.todos.map((todo, i) => `
                <div class="list-item">
                    <label class="flex items-center gap-3 text-sm cursor-pointer w-full">
                        <input type="checkbox" data-act="toggle-todo" data-index="${i}" ${todo.done ? 'checked' : ''} class="form-checkbox h-4 w-4 rounded text-pink-400 focus:ring-pink-300">
                        <span class="${todo.done ? 'line-through text-gray-400' : ''}">${todo.text}</span>
                    </label>
                    <button data-act="del" data-type="todos" data-index="${i}" class="delete-btn">‚ùå</button>
                </div>
            `).join('') || `<p class="text-xs text-center text-gray-400 py-2">All tasks completed! ‚ú®</p>`;
        }
        
        function renderHabits() {
            $('#habit-tracker').innerHTML = dailyHabits.map((habit) => `
                 <div class="list-item">
                    <label class="flex items-center gap-3 text-sm cursor-pointer">
                        <input type="checkbox" data-act="toggle-habit" data-habit="${habit}" ${state.habits.completed.includes(habit) ? 'checked' : ''} class="form-checkbox h-4 w-4 rounded text-blue-500 focus:ring-blue-400">
                        <span>${habit}</span>
                    </label>
                </div>
            `).join('');
        }

        function renderGenericList(type, containerSel) {
            const list = $(containerSel);
            if (!list) return;
            list.innerHTML = state[type].map((it, i) => `
                <div class="list-item">
                    <p class="text-sm text-gray-600">${it.content.replace(/</g, "&lt;")}</p>
                    <button data-act="del" data-type="${type}" data-index="${i}" class="delete-btn">‚ùå</button>
                </div>`).join('') || `<p class="text-xs text-center text-gray-400 py-2">No notes saved.</p>`;
        }
        
        function renderPrompts() {
            $('#prompt-cards').innerHTML = prompts.map(p => `
                <button class="quick-action-card" data-prompt-title="${p.title}" data-prompt-desc="${p.desc}">
                    <div class="font-semibold text-sm text-gray-800">${p.title}</div>
                    <div class="text-xs text-gray-500">${p.desc}</div>
                </button>
            `).join('');
        }
        
        function renderAll() {
            renderLinks();
            renderTodos();
            renderHabits();
            renderGenericList('clipboard', '#clipboard-list');
            renderPrompts();
        }

        // ===== Gemini API Integration (with Enhanced Debugging) =====
        async function callSophieAPI() {
            const askButton = $('#ask-sophie-btn');
            const btnText = $('#btn-text');
            const loader = $('#loader');

            // --- Validation Check ---
            if (!YOUR_API_KEY) {
                showToast("API Key is missing. Please add it to the script.", 5000);
                console.error("API Key is not set in the YOUR_API_KEY variable.");
                return;
            }

            askButton.disabled = true;
            btnText.classList.add('hidden');
            loader.classList.remove('hidden');

            const userPrompt = $('#editor-input').value;
            const systemInstruction = "You are Sophie, a helpful AI assistant. Be concise, friendly, and format your responses clearly using markdown.";
            
            const payload = {
                contents: [{
                    role: "user",
                    parts: [{ text: `${systemInstruction}\n\n---\n\n${userPrompt}` }]
                }]
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${YOUR_API_KEY}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // --- Detailed Error Handling ---
                if (!response.ok) {
                    const errorBody = await response.json();
                    const errorMessage = errorBody.error?.message || `HTTP Error: ${response.status}`;
                    // Log detailed error for debugging
                    console.error("Gemini API Error Response:", errorBody);
                    // Show user-friendly message
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                
                if (result.candidates?.[0]?.content?.parts?.[0]) {
                    const sophieResponse = result.candidates[0].content.parts[0].text;
                    const editor = $('#editor-input');
                    editor.value += `\n\n---\n\n**Sophie's Response:**\n${sophieResponse}`;
                    editor.scrollTop = editor.scrollHeight;
                    save();
                } else {
                    // Handle cases where the response is OK but has no content
                    console.warn("API response was successful but contained no content.", result);
                    showToast("Sophie returned an empty response.");
                }

            } catch (error) {
                console.error("Failed to call Gemini API:", error);
                showToast(`API Error: ${error.message}`, 6000);
            } finally {
                askButton.disabled = false;
                btnText.classList.remove('hidden');
                loader.classList.add('hidden');
            }
        }

        // ===== Event Handlers =====
        document.body.addEventListener('click', e => {
            const btn = e.target.closest('button');
            if (!btn) return;
            
            const { act, type, index, promptTitle, promptDesc } = btn.dataset;

            if (promptTitle) {
                const editor = $('#editor-input');
                editor.value = `${promptTitle}\n"${promptDesc}"`;
                editor.focus();
                return;
            }

            if (act === 'del') {
                state[type].splice(+index, 1);
                save();
                if (type === 'links') renderLinks();
                else if (type === 'todos') renderTodos();
                else renderGenericList(type, `#${type}-list`);
            }
        });
        
        document.body.addEventListener('change', e => {
            const input = e.target.closest('input[type="checkbox"]');
            if (!input) return;

            const {act, index, habit} = input.dataset;

            if (act === 'toggle-todo') {
                state.todos[+index].done = input.checked;
                save();
                renderTodos();
            }
            if (act === 'toggle-habit') {
                if (input.checked) {
                    if (!state.habits.completed.includes(habit)) state.habits.completed.push(habit);
                } else {
                    state.habits.completed = state.habits.completed.filter(h => h !== habit);
                }
                save();
            }
        });

        function setupForm(formId, inputId, handlerFn) {
            const form = $(formId);
            const input = $(inputId);
            form?.addEventListener('submit', e => {
                e.preventDefault();
                const value = input.value.trim();
                if (!value) return;
                handlerFn(value);
                input.value = '';
            });
        }

        // ===== Initial Setup =====
        document.addEventListener('DOMContentLoaded', () => {
            load();
            
            setupForm('#add-link-form', '#link-title-input', () => {
                const title = $('#link-title-input').value.trim();
                const url = $('#link-url-input').value.trim();
                if (title && url) {
                    state.links.unshift({ title, url });
                    $('#link-url-input').value = '';
                    save();
                    renderLinks();
                }
            });

            setupForm('#add-clipboard-form', '#clipboard-input', (value) => {
                state.clipboard.unshift({ content: value, timestamp: ts() });
                save();
                renderGenericList('clipboard', '#clipboard-list');
            });
            
            setupForm('#add-todo-form', '#todo-input', (value) => {
                state.todos.unshift({ text: value, done: false });
                save();
                renderTodos();
            });

            $('#editor-input')?.addEventListener('input', save);
            $('#ask-sophie-btn')?.addEventListener('click', callSophieAPI);
        });
    </script>
</body>
</html>
