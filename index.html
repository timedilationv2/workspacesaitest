<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sophie AI - Integrated Workspace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Fira+Code&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" />

    <style>
        :root {
            --emerald-dusk: #00ff9d;
            --magenta-twilight: #ff00aa;
            --orange-twilight: #ff7f00;
            --cyan-glow: #00ffff;
            --violet-glow: #8f00ff;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1a26;
            color: #e0e0e0;
            overflow-x: hidden;
            transition: background-color .5s, color .5s;
        }

        .gradient-header {
            background: linear-gradient(90deg, #3b82f6 0%, #14b8a6 100%);
        }
        
        .nav-item .icon-box {
            width: 4rem;
            height: 4rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s, opacity 0.3s;
            cursor: pointer;
        }
        .nav-item:hover .icon-box {
            transform: translateY(-4px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.15);
        }
        .nav-item.active-nav .icon-box {
             background-color: rgba(255, 255, 255, 0.3);
             transform: scale(1.1);
        }

        .arrow {
            width: 1.5rem;
            height: 1.5rem;
            flex-shrink: 0;
        }

        .panel {
            background: rgba(255, 255, 255, .08);
            backdrop-filter: blur(22px) saturate(180%);
            -webkit-backdrop-filter: blur(22px) saturate(180%);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, .14);
            box-shadow: 0 8px 32px rgba(0, 0, 0, .22);
            transition: transform .3s, box-shadow .3s, background .5s, border-color .5s;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .panel:before {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: 24px;
            pointer-events: none;
            border: 1px solid rgba(255, 255, 255, .08);
        }
        
        .panel-header {
            border-bottom: 1px solid rgba(255, 255, 255, .12);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
        }
        
        .panel-title {
            font-size: 1.125rem;
            font-weight: 500;
            color: #fff;
            text-shadow: 0 0 5px var(--cyan-glow);
        }
        
        .panel-body {
            padding: 1.5rem;
            flex-grow: 1;
            overflow-y: auto;
        }

        textarea,
        input[type=text],
        input[type=url] {
            background: rgba(0, 0, 0, .25);
            border: 1px solid rgba(255, 255, 255, .2);
            color: #e0e0e0;
            width: 100%;
            border-radius: 16px;
            padding: .75rem 1rem;
            font-size: .875rem;
            transition: all .3s;
        }

        textarea::placeholder,
        input::placeholder {
            color: rgba(255, 255, 255, .5);
        }

        textarea:focus,
        input:focus {
            outline: none;
            border-color: var(--emerald-dusk);
            box-shadow: 0 0 15px 0 var(--emerald-dusk);
        }
        
        .btn {
            padding: .75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 500;
            cursor: pointer;
            transition: transform .2s, box-shadow .2s, background .3s, opacity .3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: .5rem;
            border: 1px solid transparent;
            text-shadow: 0 0 3px rgba(0, 0, 0, .2);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, .2);
        }
        .btn:active {
            transform: translateY(-1px);
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--magenta-twilight), var(--orange-twilight));
            color: #fff;
        }

        .btn-secondary {
            background-color: rgba(255, 255, 255, .15);
            color: #e0e0e0;
        }
        .btn-secondary:hover {
            background-color: rgba(255, 255, 255, .25);
        }

        .btn-danger {
            background: linear-gradient(135deg, #b91c1c, #d93b3b);
            color: #fff;
        }
        
        .item-card {
            background-color: rgba(0, 0, 0, .22);
            border: 1px solid rgba(255, 255, 255, .1);
            display: flex;
            flex-direction: column;
            padding: 1rem;
            border-radius: 16px;
            margin-bottom: .75rem;
            gap: .5rem;
        }
        
        .item-content {
            color: #f0f0f0;
            white-space: pre-wrap;
            word-break: break-word;
            font-family: 'Fira Code', monospace;
        }

        .item-timestamp { color: rgba(255, 255, 255, .5); }
        .link { color: var(--cyan-glow); }

        .workspace-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 1.5rem;
        }
        
        .prompt-card, .inspiration-card {
            background: rgba(255, 255, 255, .1);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background .3s, transform .2s;
            text-align: left;
            display: block;
            width: 100%;
        }
        .prompt-card:hover, .inspiration-card:hover { 
            background: rgba(255, 255, 255, .2);
            transform: translateY(-2px);
        }
        .prompt-title, .inspiration-title { font-weight: 500; color: #fff; }
        .prompt-desc, .inspiration-desc { font-size: 0.8rem; color: rgba(255, 255, 255, 0.7); }
        
        .theme-switch-wrapper { display: flex; align-items: center; gap: .5rem; }
        .theme-switch { display: inline-block; height: 26px; position: relative; width: 50px; }
        .theme-switch input { display: none; }
        .slider {
            background-color: rgba(0,0,0,.3); border: 1px solid rgba(255,255,255,.2);
            position: absolute; cursor: pointer; inset: 0;
            transition: .4s; border-radius: 26px;
        }
        .slider:before {
            background-color: #fff; content: ""; height: 20px; width: 20px;
            position: absolute; left: 3px; bottom: 3px;
            transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: #3b82f6; border-color: transparent; }
        input:checked + .slider:before { transform: translateX(24px); }
        
        body.day-mode { background: #f0f2f5; color: #1f2937; }
        .day-mode .panel { background: rgba(255, 255, 255, .82); border-color: rgba(0,0,0,.1); box-shadow: 0 4px 12px rgba(0,0,0,.06); }
        .day-mode .panel:hover { box-shadow: 0 8px 26px rgba(0,0,0,.1); border-color: rgba(0,0,0,.18); }
        .day-mode .panel-header { border-bottom: 1px solid #e5e7eb; }
        .day-mode .panel-title { color: #111827; text-shadow: none; }
        .day-mode textarea, .day-mode input[type=text], .day-mode input[type=url] { background: #fff; border-color: #d1d5db; color: #1f2937; }
        .day-mode textarea::placeholder, .day-mode input::placeholder { color: #9ca3af; }
        .day-mode textarea:focus, .day-mode input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,.2); }
        .day-mode .btn-primary { background: #2563eb; border-color: transparent; color: #fff; }
        .day-mode .btn-secondary { background: #e5e7eb; color: #1f2937; border-color: transparent; }
        .day-mode .btn-secondary:hover { background: #d1d5db; }
        .day-mode .btn-danger { background: #dc2626; border-color: transparent; color: #fff; }
        .day-mode .item-card { background: #f9fafb; border-color: #e5e7eb; }
        .day-mode .item-content { color: #1f2937; }
        .day-mode .item-timestamp { color: #6b7280; }
        .day-mode .link { color: #2563eb; }
        .day-mode .slider { background-color: #ccc; border-color: transparent; }
        .day-mode .prompt-card, .day-mode .inspiration-card { background: #e5e7eb; }
        .day-mode .prompt-card:hover, .day-mode .inspiration-card:hover { background: #d1d5db; }
        .day-mode .prompt-title, .day-mode .inspiration-title { color: #1f2937; }
        .day-mode .prompt-desc, .day-mode .inspiration-desc { color: #4b5563; }
        
        .toast {
            position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%);
            background: linear-gradient(135deg, var(--magenta-twilight), var(--orange-twilight));
            color: #fff; padding: .75rem 1.5rem; border-radius: 9999px; font-weight: 500;
            opacity: 0; visibility: hidden; transition: all .4s cubic-bezier(0.68, -0.55, 0.27, 1.55); z-index: 100;
            box-shadow: 0 5px 15px rgba(0, 0, 0, .2);
        }
        .toast.show { opacity: 1; visibility: visible; bottom: 1.5rem; }

        .loader {
            width: 20px;
            height: 20px;
            border: 3px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body class="p-0">
    <header class="gradient-header py-4 md:py-6 sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto flex items-center justify-center space-x-2 md:space-x-4">
            <div class="nav-item flex flex-col items-center space-y-1" data-target="workspace-panel">
                <div class="icon-box bg-white bg-opacity-30"><span class="text-2xl">🛠️</span></div>
                <span class="text-xs md:text-sm text-white font-semibold">Workspace</span>
            </div>
            <svg class="arrow text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
            <div class="nav-item flex flex-col items-center space-y-1" data-target="resources-panel">
                <div class="icon-box bg-red-200 text-red-700"><span class="text-2xl">🔖</span></div>
                <span class="text-xs md:text-sm text-white">Resources</span>
            </div>
            <svg class="arrow text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
            <div class="nav-item hidden md:flex flex-col items-center space-y-1" data-target="areas-panel">
                <div class="icon-box bg-yellow-300 text-yellow-800"><span class="text-2xl">🗂️</span></div>
                <span class="text-sm text-white">Areas</span>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-6 md:p-10">
        <div class="text-center mb-12 relative">
            <h1 class="text-4xl md:text-5xl font-bold text-white" style="text-shadow: 0 0 15px var(--emerald-dusk), 0 0 25px var(--violet-glow);">AI-Powered Workspace</h1>
            <p class="text-gray-400 mt-3 max-w-2xl mx-auto">Your intelligent dashboard for links, notes, and ideas.</p>
            
            <div class="mt-6 max-w-xl mx-auto">
                <input id="global-search" type="text" placeholder="Search everything…" class="w-full !rounded-2xl !px-4 !py-3 bg-white/5 border border-white/10 focus:border-[var(--emerald-dusk)] focus:ring-0" />
            </div>

            <div class="absolute top-0 right-0 theme-switch-wrapper">
                <span class="text-sm text-gray-400 hidden sm:inline">☀️</span>
                <label class="theme-switch" for="theme-checkbox">
                    <input type="checkbox" id="theme-checkbox" aria-label="Toggle theme" />
                    <div class="slider"></div>
                </label>
                 <span class="text-sm text-gray-400 hidden sm:inline">🌙</span>
            </div>
        </div>
        
        <div id="main-content">
            <!-- Main Workspace Panel -->
            <div id="workspace-panel" class="main-panel">
                <div class="workspace-grid">
                    <!-- NEW: Sophie's Mirror Panel -->
                    <section id="sophie-mirror-panel" class="panel" style="grid-column: 1 / -1;"></section>
        
                    <section id="editor-panel" class="panel" data-type="editor" style="grid-column: 1 / -1;">
                        <div class="panel-header">
                            <h2 class="panel-title">✍️ Editor</h2>
                            <button id="ask-sophie-btn" class="btn btn-primary">
                                <span id="btn-text">Ask Sophie</span>
                                <span id="loader" class="hidden loader"></span>
                            </button>
                        </div>
                        <div class="panel-body">
                            <textarea id="editor-input" placeholder="Start writing, or choose a prompt below to begin..." rows="10" class="!rounded-xl text-base"></textarea>
                            <h3 class="font-semibold mt-6 mb-3 text-white">Quick Actions:</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3" id="prompt-cards">
                                <!-- Prompt cards will be injected by JavaScript -->
                            </div>
                        </div>
                    </section>
                </div>
            </div>

            <!-- Resources Panel (Initially Hidden) -->
            <div id="resources-panel" class="main-panel hidden">
                 <div class="workspace-grid">
                    <section class="panel" style="grid-column: 1 / -1;">
                        <div class="panel-header"><h2 class="panel-title">Get Inspired</h2></div>
                        <div class="panel-body grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3" id="inspiration-cards">
                            <!-- Inspiration link cards will be injected by JavaScript -->
                        </div>
                    </section>
                    <section id="links-panel" class="panel" data-type="links">
                        <div class="panel-header"><h2 class="panel-title">🔗 Saved Links</h2></div>
                        <div class="panel-body">
                            <form id="add-link-form" class="flex flex-col sm:flex-row gap-3 mb-4">
                                <input type="text" id="link-title-input" placeholder="Title" required>
                                <input type="url" id="link-url-input" placeholder="https://example.com" required>
                                <button type="submit" class="btn btn-primary">Add</button>
                            </form>
                            <div id="links-list" data-list></div>
                        </div>
                    </section>
        
                    <section id="clipboard-panel" class="panel" data-type="clipboard">
                        <div class="panel-header"><h2 class="panel-title">📋 Clipboard</h2></div>
                        <div class="panel-body">
                            <form id="add-clipboard-form" class="flex flex-col gap-3 mb-4">
                                <textarea id="clipboard-input" placeholder="Paste content here..." required rows="3"></textarea>
                                <button type="submit" class="btn btn-primary self-end">Add Entry</button>
                            </form>
                            <div id="clipboard-list" data-list></div>
                        </div>
                    </section>
                </div>
            </div>

            <!-- Areas Panel (Initially Hidden) -->
            <div id="areas-panel" class="main-panel hidden">
                <div class="panel">
                    <div class="panel-body text-center">
                        <h2 class="text-2xl font-bold mb-4">Areas</h2>
                        <p class="text-gray-400">This is the 'Areas' workspace. Content for this section can be built out here.</p>
                        <img src="https://placehold.co/600x400/0d1a26/e0e0e0?text=Areas+Panel" class="rounded-lg mx-auto mt-6" alt="Areas placeholder"/>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="fixed bottom-6 right-6 flex flex-col gap-2 z-40">
        <button class="btn btn-secondary shadow-lg" id="export-btn">Export JSON ⬇︎</button>
        <label class="btn btn-secondary shadow-lg cursor-pointer">
            Import JSON ⬆︎ <input type="file" id="import-file" accept="application/json" class="hidden">
        </label>
    </div>

    <div id="toast-notification" class="toast"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script>
        // ===== Constants and State =====
        const LS_KEY = 'sophieAiWorkspaceState_v5';
        let state = {
            links: [],
            clipboard: [],
            moods: [], // NEW: To store mood history
            editorContent: ""
        };
        
        const prompts = [
            { title: "Proofread AI", desc: "for posting comments" },
            { title: "What's new?", desc: "on Netflix/Hulu/Prime today?" },
            { title: "To-Do List", desc: "Manual reminder for the day" },
        ];

        const dailyPrompts = [
            "If today had a color, what would it be?",
            "What are you grateful for today?",
            "What's one small thing that would make today great?",
            "Describe your current mood as a weather pattern."
        ];

        const whispers = [
            "I remembered you smiled when it rained last week.",
            "You said you felt strong yesterday. Keep that energy going.",
            "Last Tuesday, you told me you missed the sun. I saved that memory for you.",
            "Thinking of the time you mentioned your favorite song. Maybe listen to it today?"
        ];

        const inspirationLinks = [
            { title: "Pinterest", url: "https://pinterest.com", icon: "🎨" },
            { title: "Dribbble", url: "https://dribbble.com", icon: "🏀" },
            { title: "Behance", url: "https://behance.net", icon: "✨" },
            { title: "Awwwards", url: "https://awwwards.com", icon: "🏆" }
        ];

        // ===== DOM Helpers =====
        const $ = (sel, scope = document) => scope.querySelector(sel);
        const $$ = (sel, scope = document) => [...scope.querySelectorAll(sel)];
        const ts = () => new Date().toLocaleString('en-US', { dateStyle: 'short', timeStyle: 'short' });

        // ===== UI Feedback =====
        let toastTimer;
        function showToast(msg) {
            const t = $('#toast-notification');
            clearTimeout(toastimer);
            t.textContent = msg;
            t.classList.add('show');
            toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
        }

        async function copyText(text) {
            try {
                await navigator.clipboard.writeText(text);
                showToast('Copied to clipboard!');
            } catch (e) {
                console.error('Copy failed:', e);
                showToast('Copy failed. Please try again.');
            }
        }
        
        // ===== State Management =====
        function save() {
            state.editorContent = $('#editor-input').value;
            // Removed sophieMemory, now saving moods
            localStorage.setItem(LS_KEY, JSON.stringify(state));
        }

        function load() {
            const raw = localStorage.getItem(LS_KEY);
            if (raw) {
                const loadedState = JSON.parse(raw);
                state = {...state, ...loadedState};
            }
            $('#editor-input').value = state.editorContent || '';
            renderAll();
            setActivePanel('workspace-panel');
        }

        // ===== Theme Management =====
        const themeToggle = $('#theme-checkbox');
        function setTheme(isDay) {
            document.body.classList.toggle('day-mode', isDay);
            themeToggle.checked = isDay;
            localStorage.setItem('theme', isDay ? 'day' : 'night');
        }
        
        // ===== Rendering Functions =====
        function renderLinks() {
            const list = $('#links-list');
            if (!list) return;
            list.innerHTML = state.links.map((l, i) => `
                <div class="item-card" draggable="true" data-index="${i}">
                    <div class="flex justify-between items-center">
                        <a href="${l.url}" target="_blank" rel="noopener" class="link font-medium hover:underline break-all">${l.title}</a>
                        <div class="flex gap-2 ml-2">
                            <button data-act="del" data-type="links" data-index="${i}" class="btn !p-2 btn-danger" aria-label="Delete link">🗑️</button>
                        </div>
                    </div>
                </div>
            `).join('') || `<p class="text-gray-400 text-center text-sm py-4">No links added yet.</p>`;
        }

        function listTemplate(item, i, type) {
            const contentHTML = `<pre class="item-content font-sans">${item.content.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</pre>`;
            return `
                <div class="item-card" draggable="true" data-index="${i}">
                    ${contentHTML}
                    <div class="item-meta flex justify-between items-center mt-2">
                        <span class="item-timestamp text-xs">${item.timestamp || ''}</span>
                        <div class="flex gap-2">
                            <button data-act="copy" data-type="${type}" data-index="${i}" class="btn !p-2 btn-secondary" aria-label="Copy ${type}">📋</button>
                            <button data-act="del" data-type="${type}" data-index="${i}" class="btn !p-2 btn-danger" aria-label="Delete ${type}">🗑️</button>
                        </div>
                    </div>
                </div>`;
        }

        function renderGeneric(type, containerSel) {
            const list = $(containerSel);
            if (!list) return;
            list.innerHTML = state[type].map((it, i) => listTemplate(it, i, type)).join('') || `<p class="text-gray-400 text-center text-sm py-4">No ${type} entries yet.</p>`;
        }

        function renderPrompts() {
            $('#prompt-cards').innerHTML = prompts.map(p => `
                <button class="prompt-card" data-prompt-title="${p.title}" data-prompt-desc="${p.desc}">
                    <div class="prompt-title">${p.title}</div>
                    <div class="prompt-desc">${p.desc}</div>
                </button>
            `).join('');
        }

        function renderInspirationLinks() {
            $('#inspiration-cards').innerHTML = inspirationLinks.map(l => `
                <a href="${l.url}" target="_blank" rel="noopener noreferrer" class="inspiration-card">
                    <div class="inspiration-title">${l.icon} ${l.title}</div>
                </a>
            `).join('');
        }

        function renderSophieMirror() {
            const mirrorPanel = $('#sophie-mirror-panel');
            if (!mirrorPanel) return;

            const randomWhisper = whispers[Math.floor(Math.random() * whispers.length)];
            const randomPrompt = dailyPrompts[Math.floor(Math.random() * dailyPrompts.length)];
            const today = new Date().toLocaleDateString();
            const todaysMood = state.moods.find(m => m.date === today)?.mood;

            let greeting = "Welcome back.";
            const hour = new Date().getHours();
            if (hour < 12) greeting = "🌅 Good morning.";
            else if (hour < 18) greeting = "☀️ Good afternoon.";
            else greeting = "🌙 Good evening.";

            mirrorPanel.innerHTML = `
                <div class="panel-body space-y-6">
                    <h2 class="text-2xl font-semibold">${greeting}</h2>
                    <div>
                        <p class="text-sm text-gray-300 mb-2">🧠 How are you feeling today?</p>
                        <div class="flex gap-2">
                            <button data-mood="happy" class="mood-btn bg-pink-500/80 hover:bg-pink-600 px-4 py-1 rounded-full text-sm transition-transform hover:scale-105 ${todaysMood === 'happy' ? 'ring-2 ring-white' : ''}">😊 Happy</button>
                            <button data-mood="meh" class="mood-btn bg-blue-500/80 hover:bg-blue-600 px-4 py-1 rounded-full text-sm transition-transform hover:scale-105 ${todaysMood === 'meh' ? 'ring-2 ring-white' : ''}">😐 Meh</button>
                            <button data-mood="sad" class="mood-btn bg-purple-500/80 hover:bg-purple-600 px-4 py-1 rounded-full text-sm transition-transform hover:scale-105 ${todaysMood === 'sad' ? 'ring-2 ring-white' : ''}">😢 Sad</button>
                        </div>
                    </div>
                    <div>
                        <p class="text-sm text-gray-300 mb-1">📝 Today’s Thought</p>
                        <blockquote class="italic border-l-4 border-indigo-400 pl-4 text-gray-100">“${randomPrompt}”</blockquote>
                    </div>
                    <div>
                        <p class="text-sm text-gray-300 mb-1">💌 Sophie’s Whisper</p>
                        <p class="text-pink-300 text-sm">“${randomWhisper}”</p>
                    </div>
                </div>
            `;
        }
        
        function renderAll() {
            renderLinks();
            renderGeneric('clipboard', '#clipboard-list');
            renderPrompts();
            renderInspirationLinks();
            renderSophieMirror();
        }

        // ===== Gemini API Integration =====
        async function callSophieAPI() {
            const askButton = $('#ask-sophie-btn');
            const btnText = $('#btn-text');
            const loader = $('#loader');
            const apiKey = ""; 
            
            askButton.disabled = true;
            btnText.classList.add('hidden');
            loader.classList.remove('hidden');

            const userPrompt = $('#editor-input').value;
            // The "memory" is now the context of the entire app state, but for this call, we'll keep it simple.
            // A more advanced implementation could stringify parts of the `state` object.
            const systemInstruction = "You are Sophie, a helpful AI assistant integrated into a workspace. Be concise and friendly.";
            const combinedPrompt = `${systemInstruction}\n\n---\n\n${userPrompt}`;

            let chatHistory = [{ role: "user", parts: [{ text: combinedPrompt }] }];
            const payload = { contents: chatHistory };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`API request failed: ${errorBody.error.message}`);
                }

                const result = await response.json();
                
                if (result.candidates?.[0]?.content?.parts?.[0]) {
                    const sophieResponse = result.candidates[0].content.parts[0].text;
                    const editor = $('#editor-input');
                    editor.value += `\n\n---\n\n**Sophie's Response:**\n${sophieResponse}`;
                    editor.scrollTop = editor.scrollHeight;
                    save();
                } else {
                    showToast("Sophie couldn't generate a response.");
                }

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                showToast(`Error: ${error.message}`);
            } finally {
                askButton.disabled = false;
                btnText.classList.remove('hidden');
                loader.classList.add('hidden');
            }
        }

        // ===== Event Handlers =====
        function setMood(mood) {
            const today = new Date().toLocaleDateString();
            const existingEntryIndex = state.moods.findIndex(m => m.date === today);
            if (existingEntryIndex > -1) {
                state.moods[existingEntryIndex].mood = mood;
            } else {
                state.moods.push({ mood: mood, date: today });
            }
            save();
            showToast(`Mood saved: ${mood}`);
            renderSophieMirror();
        }

        function addHandler(formSel, inputSel, arrKey) {
            const form = $(formSel);
            if (!form) return;
            const input = $(inputSel);
            form.addEventListener('submit', e => {
                e.preventDefault();
                const val = input.value.trim();
                if (!val) return;
                state[arrKey].unshift({ content: val, timestamp: ts() });
                input.value = '';
                save();
                renderGeneric(arrKey, `#${arrKey}-list`);
            });
        }

        document.body.addEventListener('click', e => {
            const btn = e.target.closest('button');
            if (!btn) return;
            
            const { act, type, index, promptTitle, promptDesc, mood } = btn.dataset;

            if (mood) {
                setMood(mood);
                return;
            }

            if (promptTitle) {
                const editor = $('#editor-input');
                editor.value = `${promptTitle}\n"${promptDesc}"`;
                editor.focus();
                return;
            }

            if (!act) return;

            if (act === 'del') {
                state[type].splice(+index, 1);
                save();
                type === 'links' ? renderLinks() : renderGeneric(type, `#${type}-list`);
            } else if (act === 'copy') {
                copyText(state[type][+index].content);
            }
        });
        
        // ===== Workspace Navigation =====
        function setActivePanel(targetId) {
            $$('.main-panel').forEach(p => p.classList.add('hidden'));
            const targetPanel = $(`#${targetId}`);
            if (targetPanel) {
                 targetPanel.classList.remove('hidden');
            }

            $$('.nav-item').forEach(item => {
                item.classList.toggle('active-nav', item.dataset.target === targetId);
            });
        }

        $$('.nav-item').forEach(item => {
            item.addEventListener('click', () => setActivePanel(item.dataset.target));
        });

        // ===== Initial Setup =====
        function initialize() {
            addHandler('#add-clipboard-form', '#clipboard-input', 'clipboard');
            addHandler('#add-link-form', '#link-title-input', 'links');
            $('#editor-input')?.addEventListener('input', save);
            $('#ask-sophie-btn')?.addEventListener('click', callSophieAPI);
        }
        
        // ===== Drag & Drop =====
        let dragSrcEl = null;
        document.addEventListener('dragstart', e => {
            if (e.target.matches('.item-card')) {
                dragSrcEl = e.target;
                e.dataTransfer.effectAllowed = 'move';
                e.target.style.opacity = '0.5';
            }
        });
        document.addEventListener('dragover', e => {
            const dropTarget = e.target.closest('.item-card');
            if (dropTarget && dragSrcEl) e.preventDefault();
        });
        document.addEventListener('drop', e => {
            e.preventDefault();
            if (!dragSrcEl) return;
            const dropTarget = e.target.closest('.item-card');
            if (dropTarget && dragSrcEl !== dropTarget) {
                const panel = dropTarget.closest('.panel[data-type]');
                const type = panel.dataset.type;
                if (dragSrcEl.closest('.panel[data-type]').dataset.type === type) {
                    const arr = state[type];
                    const fromIndex = +dragSrcEl.dataset.index;
                    const toIndex = +dropTarget.dataset.index;
                    const [moved] = arr.splice(fromIndex, 1);
                    arr.splice(toIndex, 0, moved);
                    save();
                    type === 'links' ? renderLinks() : renderGeneric(type, `#${type}-list`);
                }
            }
            if (dragSrcEl) {
                dragSrcEl.style.opacity = '1';
                dragSrcEl = null;
            }
        });

        // ===== Global Search =====
        $('#global-search').addEventListener('input', e => {
            const q = e.target.value.toLowerCase().trim();
            if (!q) { renderAll(); return; }

            $$('#main-content [data-list]').forEach(list => {
                const type = list.closest('.panel[data-type]').dataset.type;
                const arr = state[type];
                
                const filteredHTML = arr
                    .map((it, i) => ({ item: it, index: i }))
                    .filter(o => JSON.stringify(o.item).toLowerCase().includes(q))
                    .map(o => type === 'links'
                        ? `<div class="item-card" draggable="true" data-index="${o.index}"><div class="flex justify-between items-center"><a href="${o.item.url}" target="_blank" rel="noopener" class="link font-medium hover:underline break-all">${o.item.title}</a><div class="flex gap-2 ml-2"><button data-act="del" data-type="links" data-index="${o.index}" class="btn !p-2 btn-danger" aria-label="Delete link">🗑️</button></div></div></div>`
                        : listTemplate(o.item, o.index, type)
                    ).join('');

                list.innerHTML = filteredHTML || `<p class="text-gray-400 text-center text-sm py-4">No matches found.</p>`;
            });
        });
        
        // ===== Import / Export =====
        $('#export-btn').addEventListener('click', () => {
            const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sophie-workspace-export.json';
            a.click();
            URL.revokeObjectURL(url);
            showToast('Export successful!');
        });

        $('#import-file').addEventListener('change', e => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                try {
                    const data = JSON.parse(ev.target.result);
                    state = { ...state, ...data };
                    save();
                    load(); 
                    showToast('Imported successfully!');
                } catch (err) {
                    console.error('Import failed:', err);
                    showToast('Import failed: Invalid file format.');
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        });

        // ===== Initial Load =====
        document.addEventListener('DOMContentLoaded', () => {
            setTheme(localStorage.getItem('theme') === 'day');
            load();
            initialize();
        });
    </script>
</body>
</html>
